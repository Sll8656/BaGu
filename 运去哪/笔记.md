```java
提取所有FullfillMainContainerDTO对象的packageTypeId，去重后存入Set<Integer>类型的collect。    package com.yqn.framework.composer.api.bill_query.script;

    import cn.hutool.core.collection.CollectionUtil;
    import com.alibaba.excel.util.StringUtils;
    import com.google.common.collect.Lists;
    import com.google.common.collect.Maps;
    import com.yqn.center.order.enums.GeneralSettingType;
    import com.yqn.cpf.dto.base.PageCollection;
    import com.yqn.cpf.dto.generalSetting.dto.GeneralSettingEsDTO;
    import com.yqn.express.dto.common.GeneralContentByKeyCodeRequest;
    import com.yqn.framework.composer.api.bill_query.req.BillQueryRequest;
    import com.yqn.framework.composer.engine.context.Context;
    import com.yqn.framework.composer.language.annotation.IScript;
    import com.yqn.framework.composer.language.annotation.YqnResource;
    import com.yqn.framework.composer.process.order_create.req.GeneralSettingItemDTO;
    import com.yqn.general.dto.generalSetting.request.GeneralSettingKeyPair;
    import com.yqn.general.dto.generalSetting.request.GetGeneralListByKeyCodeRequestDTO;
    import com.yqn.general.dto.generalSetting.request.GetGeneralSettingsByKeyReq;
    import com.yqn.general.dto.generalSetting.request.KeyCodeInfo;
    import com.yqn.lclorder.config.ApolloConfig;
    import com.yqn.lclorder.util.BeanUtils;
    import com.yqn.lclorder.util.BigDecimalUtil;
    import com.yqn.lib.logging.util.RPCContext;
    import com.yqn.model.Response;
    import com.yqn.order.dto.fullfill.main.FullfillMainContainerDTO;
    import com.yqn.order.facade.vo.response.document.ContainerTypeVO;
    import com.yqn.order.facade.vo.response.generalsetting.GeneralSettingItemVO;
    import com.yqn.util.StringUtil;
    import org.apache.commons.collections.CollectionUtils;
    import org.apache.commons.collections.MapUtils;

    import java.util.*;
    import java.util.stream.Collectors;

    /**
 * 支持 @Value
 * 支持 Spring @Resource @Autowired
 * 支持 @YqnResource 该注解可从接口执行的上下文获取context的数据 如   @YqnResource private ResponseModel response;
 */
public class Script_4022174229628928 implements IScript {
    @YqnResource
    private Context context;
    @YqnResource
    ApolloConfig apolloConfig;

    @YqnResource
    private BillQueryRequest request;
    @YqnResource("Http_1FC")
    private com.yqn.order.dto.fullfill.main.FullfillMainContainerQueryDTO fullfillMainContainerQueryDTO;




    /// fullfillMain/container/getMergeContainersAndOrderNoByOrderId
    @Override
    public Object run() {
        List<ContainerTypeVO> containerTypeVOList = null;

        List<FullfillMainContainerDTO> fullfillMainContainerDTOS = new ArrayList<>();
        if (fullfillMainContainerQueryDTO != null &&
                CollectionUtil.isNotEmpty(fullfillMainContainerQueryDTO.getContainers())) {
            fullfillMainContainerDTOS = fullfillMainContainerQueryDTO.getContainers();
            containerTypeVOList = this.covertToContainerTypeVOList(fullfillMainContainerDTOS);
        }
        return fullfillMainContainerDTOS;
    }

    /**
     * 提单转换箱货数据
     *
     * @param fullfillMainContainerDTOS
     * @return
     */
    public List<ContainerTypeVO> covertToContainerTypeVOList(List<FullfillMainContainerDTO> fullfillMainContainerDTOS) {
        if (CollectionUtil.isEmpty(fullfillMainContainerDTOS)) {
            return null;
        }
        Set<Integer> collect = fullfillMainContainerDTOS.stream()
                .filter(e -> e.getPackageTypeId() != null)
                .map(e -> e.getPackageTypeId())
                .collect(Collectors.toSet());
        Map<Integer, GeneralSettingItemVO> packageTypeList = Maps.newHashMap();
        if (collect != null) {
            packageTypeList =
                    this.getGeneralItemVOsWithCnByCode(GeneralSettingType.packageStyle.getCode(),
                            new ArrayList<>(collect));
        }
        List<ContainerTypeVO> containerTypeVOList = new ArrayList<>();

        Map<String, Integer> sortMap = Maps.newHashMap();
        for (FullfillMainContainerDTO fullfillMainContainerDTO : fullfillMainContainerDTOS) {
            ContainerTypeVO containerTypeVO = ContainerTypeVO.builder()
                    .sort(this.getSortValue(sortMap, fullfillMainContainerDTO.getOrderNo())
                            .get(StringUtil.StringIsNull(fullfillMainContainerDTO.getOrderNo()) ? "null" : fullfillMainContainerDTO.getOrderNo()))
                    .fullfillMainContainerId(fullfillMainContainerDTO.getId())
                    .containerNo(fullfillMainContainerDTO.getContainerNo())
                    .sealNo(fullfillMainContainerDTO.getSealNo())
                    .containerSize(fullfillMainContainerDTO.getContainerSize())
                    .containerType(fullfillMainContainerDTO.getContainerType())
                    .containerTypeId(fullfillMainContainerDTO.getContainerTypeId())
                    .grossWeight(BigDecimalUtil.formatGrossWeight(fullfillMainContainerDTO.getGrossWeight()))
                    .volume(BigDecimalUtil.formatVolume(fullfillMainContainerDTO.getVolume()))
                    .pieces(fullfillMainContainerDTO.getPieces())
                    .packageType(packageTypeList.get(fullfillMainContainerDTO.getPackageTypeId()))
                    .orderNo(fullfillMainContainerDTO.getOrderNo())
                    .build();
            containerTypeVOList.add(containerTypeVO);
        }

        //对返回值进行orderNo归类并根据sort进行排序
        containerTypeVOList = this.containerTypeVOSort(containerTypeVOList);

        return containerTypeVOList;
    }


    /**
     * @Description // 从给定参数map中获取orderNo对应的排序序号
     **/
    private Map<String,Integer> getSortValue(Map<String,Integer> map,String key){

        if(map.get(key) == null){
            //不存在value--需要放入
            if(StringUtil.StringIsNull(key)){
                map.put("null",1);
            }
            else{
                map.put(key,1);
            }
        }else {
            //存在value
            Integer mapReturn=map.get(key);
            map.replace(key,++mapReturn);
        }

        return map;
    }
    /**
     * @Description // 对List<ContainerTypeVO>进行orderNo归类并根据sort进行排序
     **/
    private List<ContainerTypeVO> containerTypeVOSort(List<ContainerTypeVO> params){
        //参数验证
        if(CollectionUtil.isEmpty(params)){
            return null;
        }

        //根据订单归类
        Map<String,List<ContainerTypeVO>> map=Maps.newHashMap();
        for (ContainerTypeVO item:params){
            List<ContainerTypeVO> tempList= Lists.newArrayList();
            String key;
            if(StringUtil.StringIsNull(item.getOrderNo())){
                //orderNo为null情况处理
                key="null";
            }else{
                //orderNo不为null处理
                key=item.getOrderNo();
            }

            if(map.get(key) == null){
                tempList.add(item);
                map.put(key,tempList);
            }
            else {
                tempList=map.get(key);
                tempList.add(item);
                map.replace(key,tempList);
            }
        }

        //针对map中的value值进行sort排序
        List<ContainerTypeVO> result=Lists.newArrayList();
        for(List<ContainerTypeVO> mapValues:map.values()){
            if(CollectionUtil.isNotEmpty(mapValues)){
                //进行排序
                Collections.sort(mapValues, new Comparator<ContainerTypeVO>() {
                    @Override
                    public int compare(ContainerTypeVO o1, ContainerTypeVO o2) {
                        int diff=o1.getSort() - o2.getSort();
                        if(diff > 0){
                            return 1;
                        }
                        else if(diff < 0){
                            return -1;
                        }
                        return 0;
                    }
                });// 按sort排序

                //添加到返回值
                result.addAll(mapValues);
            }
        }

        return result;
    }


    public Map<Integer, GeneralSettingItemVO> getGeneralItemVOsWithCnByCode(String categoryKey,
                                                                            List<Integer> selectedValues) {
        if (CollectionUtil.isEmpty(selectedValues)) {
            return Maps.newHashMap();
        }

        List<GeneralSettingItemDTO> itemDTOs = this.getGeneralItemDTOByCode(categoryKey, selectedValues);

        Map<Integer, GeneralSettingItemVO> resultMap = Maps.newHashMap();
        if (CollectionUtil.isNotEmpty(itemDTOs)) {
            itemDTOs.forEach(item -> {
                if (item != null) {
                    resultMap.put(item.getSelectedValue(), this.convertToDstWithEn(item));
                }
            });
        }

        return resultMap;
    }

    /**
     * 获取通用数据DTO List
     *
     * @param categoryKey
     * @param selectedValues
     * @return
     */
    public List<GeneralSettingItemDTO> getGeneralItemDTOByCode(String categoryKey,
                                                               List<Integer> selectedValues) {
        if (CollectionUtil.isEmpty(selectedValues)) {
            return Lists.newArrayList();
        }

        List<GeneralContentByKeyCodeRequest.GeneralByKeyCode> generalByKeyCodes = Lists.newArrayList();
        selectedValues.forEach(x -> {
            GeneralContentByKeyCodeRequest.GeneralByKeyCode generalByKeyCode = GeneralContentByKeyCodeRequest.GeneralByKeyCode.builder()
                    .key(categoryKey)
                    .selectedValue(x)
                    .build();
            generalByKeyCodes.add(generalByKeyCode);
        });

        List<GeneralSettingItemDTO> itemDTOs = this.getGeneralItemByCode(generalByKeyCodes);

        return itemDTOs;
    }

    public List<GeneralSettingItemDTO> getGeneralItemByCode(List<GeneralContentByKeyCodeRequest.GeneralByKeyCode> generalByKeyCodes) {
        if (CollectionUtil.isEmpty(generalByKeyCodes)) {
            return null;
        }

        if (this.orderServiceConfig.getSwitchGeneral()) {
            List<GeneralSettingKeyPair> pairs = Lists.newArrayList();

            Map<String, List<GeneralContentByKeyCodeRequest.GeneralByKeyCode>> collect = generalByKeyCodes.stream()
                    .filter(item -> StringUtils.isNotBlank(item.getKey()))
                    .collect(Collectors.groupingBy(GeneralContentByKeyCodeRequest.GeneralByKeyCode::getKey));
            if (MapUtils.isEmpty(collect)) {
                return Lists.newArrayList();
            }

            for (String key : collect.keySet()) {
                List<Integer> selectedValues
                        = collect.get(key).stream()
                        .filter(item -> item.getSelectedValue() != null)
                        .map(item -> item.getSelectedValue())
                        .collect(Collectors.toList());
                if (CollectionUtil.isEmpty(selectedValues)) {
                    continue;
                }

                GeneralSettingKeyPair pair = GeneralSettingKeyPair.builder()
                        .key(key)
                        .selectedValues(selectedValues)
                        .build();

                pairs.add(pair);
            }

            return getByKeyAndSeclectedValue(pairs);
        }

        GetGeneralListByKeyCodeRequestDTO getGeneralListByKeyCodeRequestDTO = new GetGeneralListByKeyCodeRequestDTO();
        List<KeyCodeInfo> keyCodeInfos = new ArrayList<>();
        generalByKeyCodes.forEach(
                item -> {
                    KeyCodeInfo keyCodeInfo = new KeyCodeInfo();
                    keyCodeInfo.setKey(item.getKey());
                    keyCodeInfo.setSelectedValue(item.getSelectedValue());
                    keyCodeInfos.add(keyCodeInfo);
                }
        );
        getGeneralListByKeyCodeRequestDTO.setKeyCodeList(keyCodeInfos);
        getGeneralListByKeyCodeRequestDTO.setPage(1);
        getGeneralListByKeyCodeRequestDTO.setPageSize(999);
        Response<PageCollection<GeneralSettingEsDTO>> pageCollectionResponse = iGeneralSettingClient.GetGeneralListByKeyCode(RPCContext.createRequest(getGeneralListByKeyCodeRequestDTO));
        if (null == pageCollectionResponse) {
            return null;
        }
        PageCollection<GeneralSettingEsDTO> data = pageCollectionResponse.getData();
        if (null == data) {
            return null;
        }
        List<GeneralSettingEsDTO> generals = data.getData();
        if (CollectionUtils.isEmpty(generals)) {
            return null;
        }

        List<GeneralSettingItemDTO> returnLists = new ArrayList<>();
        generals.forEach(
                item -> {
                    GeneralSettingItemDTO generalSettingItemDTO = new GeneralSettingItemDTO();
                    if (item != null) {
                        BeanUtils.copyProperties(item, generalSettingItemDTO);
                        generalSettingItemDTO.setId(item.getId() == null ? null : item.getId().intValue());
                        generalSettingItemDTO.setKey(item.getMainEnglishName());
                        generalSettingItemDTO.setCategoryId(item.getCategoryId().intValue());
                        returnLists.add(generalSettingItemDTO);
                    }
                }
        );
        return returnLists;
    }

    /**
     * 通用数据查询
     *
     * @param keyPairs
     * @return
     */
    public List<GeneralSettingItemDTO> getByKeyAndSeclectedValue(List<GeneralSettingKeyPair> keyPairs) {
        GetGeneralSettingsByKeyReq req = GetGeneralSettingsByKeyReq.builder().keyPairs(keyPairs).build();
        Response<List<com.yqn.general.dto.generalSetting.dto.GeneralSettingEsDTO>> response = generalSettingV2Client.getByKeyAndSeclectedValue(RPCContext.createRequest(req));

        if (response != null && CollectionUtils.isNotEmpty(response.getData())) {
            List<com.yqn.general.dto.generalSetting.dto.GeneralSettingEsDTO> generals = response.getData();

            List<GeneralSettingItemDTO> generalSettingItemDTOS = Lists.newArrayList();
            generals.forEach(
                    item -> {
                        if (null != item) {
                            GeneralSettingItemDTO generalSettingItemDTO = new GeneralSettingItemDTO();
                            BeanUtils.copyProperties(item, generalSettingItemDTO);
                            generalSettingItemDTO.setId(null == item.getId() ? null : item.getId().intValue());
                            generalSettingItemDTO.setCategoryId(item.getCategoryId().intValue());
                            generalSettingItemDTO.setKey(item.getMainEnglishName());
                            generalSettingItemDTOS.add(generalSettingItemDTO);
                        }
                    }
            );

            return generalSettingItemDTOS;
        }

        return Lists.newArrayList();
    }

    public GeneralSettingItemVO convertToDstWithEn(GeneralSettingItemDTO itemDTO) {
        if (itemDTO == null) {
            return null;
        }

        GeneralSettingItemVO itemVO = GeneralSettingItemVO.builder()
                .id(itemDTO.getSelectedValue())
                .name(itemDTO.getEnglishName())
                .chineseName(itemDTO.getChineseName())
                .englishName(itemDTO.getEnglishName())
                .shortCode(itemDTO.getShortCode())
                .build();

        return itemVO;
    }

}

class ThreadUtil {
    private static final int   CPU_COUNT = Runtime.getRuntime().availableProcessors();
    private static final int MAXIMUM_POOL_SIZE = CPU_COUNT;
}
```







```java
 public List<ContainerTypeVO> getBillContainersWithSort(Long orderId){
        //参数校验
        if(NumberUtils.isEmpty(orderId)){
            return null;
        }

        List<ContainerTypeVO> containerTypeVOList = null;

        //查询订单合并提单业务单箱信息包含orderNo
        Response<FullfillMainContainerQueryDTO> containerQueryDTOResponse = fullfillMainClient.getMergeContainersAndOrderNoByOrderId(RPCContext.createRequest(orderId));
        if (    containerQueryDTOResponse != null &&
                containerQueryDTOResponse.getData() != null
                && CollectionUtils.isNotEmpty(containerQueryDTOResponse.getData().getContainers())) {
            //完成单箱信息
            List<FullfillMainContainerDTO> fullfillMainContainerDTOS = containerQueryDTOResponse.getData().getContainers();
            //完整单箱信息转换
            containerTypeVOList = docLoadingBillContainerTransfer.covertToContainerTypeVOList(fullfillMainContainerDTOS);
        }

        return containerTypeVOList;
    }
```





调用fullfillMainClient.getMergeContainersAndOrderNoByOrderId方法，传入orderId，获取包含订单号的合并提单业务单箱信息，结果存储在containerQueryDTOResponse中。

提取containers列表，得到List<FullfillMainContainerDTO>类型的fullfillMainContainerDTOS。

**调用docLoadingBillContainerTransfer.covertToContainerTypeVOList(fullfillMainContainerDTOS)方法，将FullfillMainContainerDTO列表转换为ContainerTypeVO列表，结果赋值给containerTypeVOList。**



进入docLoadingBillContainerTransfer.covertToContainerTypeVOList

主要目标：将FullfillMainContainerDTO列表转换为ContainerTypeVO列表，并根据特定规则进行排序。

提取所有FullfillMainContainerDTO对象的packageTypeId，去重后存入Set<Integer>类型的collect。

**使用generalSettingClient.getGeneralItemVOsWithCnByCode方法，传入包装类型的代码和collect集合，获取包装类型ID到GeneralSettingItemVO的映射，结果存储在packageTypeList中。**

（在covertToContainerTypeVOList方法中，使用generalSettingClient.getGeneralItemVOsWithCnByCode方法，获取包装类型ID与GeneralSettingItemVO的映射关系，用于填充ContainerTypeVO的packageType字段。）



创建一个新的List<ContainerTypeVO>类型的列表containerTypeVOList，用于存放转换后的数据。

初始化一个Map<String, Integer>类型的sortMap，用于记录每个orderNo对应的序号。

遍历fullfillMainContainerDTOS列表，对于每个FullfillMainContainerDTO对象：

​	调用getSortValue(sortMap, fullfillMainContainerDTO.getOrderNo())方法，获取当前orderNo对应的排序值。

​	使用Builder模式创建ContainerTypeVO对象，设置其属性，包括sort值、箱号、封号、尺寸、类型、毛重、体积、件数、包装类型、订单号等。

​	将创建的ContainerTypeVO对象添加到containerTypeVOList中。





