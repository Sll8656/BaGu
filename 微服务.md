 

![image-20240402103733549](https://s2.loli.net/2024/09/18/rXL12k6ZCfSQc4N.png)

# Spring cloud

---

问：Spring Cloud 5大组件有哪些？

答：注册中心 Nacos  eureka、负载均衡 Ribbon、远程调用 Feign、服务熔断 sentinel、网关 Gateway

---

## 服务注册

---

问：服务注册和发现是什么意思？Spring Cloud是如何实现服务注册发现的？

答：

* 服务注册：服务提供者需要把自己的信息注册到中，由eureka保存这些信息。比如服务名称、ip、端口等等
* 服务发现：消费者向eureka拉取服务列表信息，如果服务提供者有集群，则消费者利用负载均衡算法，选择其中一个发起调用
* 服务监控：服务提供者会每隔一段时间向eureka发送心跳，报告健康状态。如果eureka长时间没接收到心跳，就会剔除该服务

---

问：说说Nacos和eureka的区别

答：

共同点：

* 都支持服务注册和拉取
* 都支持服务提供者心跳方式做健康检测

不同点：

* Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式
* 临时实例心跳不正常会被提出，非临时实例则不会被剔除
* Nacos支持服务列表变更的消息推送模式，服务列表更新更及时
* Nacos集群默认采用AP方式，放集群中存在非临时实例时，采用CP模式；Eureka只有AP方式
* Nacos支持注册中心和配置中心，Eureka只有注册中心

---

## 负载均衡

---

问：负载均衡如何实现？

答：微服务的负载均衡主要使用了一个组件Ribbon，比如，我们在使用feign远程调用的过程中，底层的负载均衡就是使用了ribbon。

---

问：Ribbon负载均衡策略有哪些？

答：轮询、随机、按照权重选择（响应时间越长，权重越小）、区域就近原则，在区域内做轮询

---

问：如果想自定义负载均衡策略如何实现？

答：

* 1）创建类实现IRule接口（全局）
* 2）在客户端的配置文件中，可以配置某一个服务调用的负载均衡策略（局部）

---

## 熔断降级

---

问：什么是服务雪崩，怎么解决这个问题？

答：

服务雪崩：指一个服务失败，导致整条链路服务都失败的情形、

解决服务雪崩的方法：

​	1）服务降级 ：服务的自我保护机制，用于确保服务不会因为请求突然增多而变得不可用，确保服务不会崩溃，**一般在实际开发中与feign接口整合，编写降级逻辑**

​	2）服务熔断：默认关闭，需要手动打开。入股哦检测到10秒内请求的失败率超过50%，就触发熔断机制。之后**每隔5秒重新尝试请求**微服务，如果微服务不能响应，继续走熔断机制。如果能响应了，就关闭熔断机制，恢复正常请求

---

## 服务监控

---

问：你们的微服务是怎么监控的？

答：使用skywalking。

1、它主要可以监控接口、服务、物理实例的一些状态。特别是在压测的时候可以看到众多服务中有哪些服务和接口比较慢，可以针对性的分析优化。

2、skywalking中能设置告警规则。项目上线后，如果报错了，通过告警规则可以立即发送短信或者右键通知相关负责人，可以缩短bug的持续的时间。

---

# 业务相关

![image-20240408204544510](https://s2.loli.net/2024/09/18/u1OoJ4pigABRa3q.png)

---

## 限流

---

问：你们项目中有没有做过限流？怎么做的？

答：

1、先介绍业务什么情况下去做限流

* 我们当时有一个活动，到了假期就会抢购优惠券，QPS最高可以达到2000，平时10-15之间，为了应对突发流量，需要做限流。
* 常规限流，为了防止恶意攻击，保护系统正常运行。我们使用压力测试得到系统能够承受的最大QPS

2、nginx限流

* 控制速率（突发流量），使用漏桶算法来实现过滤，让系统以固定的速率处理请求，可以应对突发流量
* 控制并发数，限制单个ip的链接数和并发链接的总数

3、网关限流

* 在spring cloud gateway中支持局部过滤器`RequestRateLimiter`来做限流，使用的是令牌桶算法
* 可以根据ip或路径进行限流，可以设置每秒填充平均速率，和令牌桶总容量

---

问：限流常见的算法有哪些？

答：

​	1）漏桶：不管请求速度是多少QPS进的桶，出桶的速率是不变的

​	2）令牌桶：桶中按一定速率生成令牌，满了就不再生成。当请求进来，只有拿到令牌才能出去。

---

## 分布式事务

---

问：解释一下CAP和BASE

答：

* CAP定理（一致性、可用性、分区容错性）

  1）分布式系统节点通过网络连接，一定会出现分区问题（P）

  2）当分区出现时，系统的一致性（C）和可用性（A）就无法同时满足

* BASE理论

  1）基本可用

  2）软状态

  3）最终一致

* 解决分布式事务的思想和模型

  1）最终一致思想：各分支事务分别执行并提交，如果有不一致的情况，再想办法恢复数据（AP）

  2）强一致思想：各分支事务执行完业务不要提交，等待彼此结果。而后统一提交或回滚（CP）

---

问：你们采用哪种分布式事务解决方案？

---

解决雪崩问题的常见方案有哪些？

> **请求限流：**限制流量在服务可以处理的范围
>
> **线程隔离：**控制业务可用的线程数量，将故障隔离在一定范围(泰坦尼克号船舱隔离板)
>
> **服务熔断：**将异常比例过高的接口断开，直接走fallback
>
> **失败处理：**定义fallback逻辑，让业务失败不再抛出异常，而是返回默认数据或者友好提示
